(function(n,t){"use strict";n._arrayBufferToBase64=function(t){for(var r="",u=new Uint8Array(t),f=u.byteLength,i=0;i<f;i+=1)r+=String.fromCharCode(u[i]);return n.btoa(r)};var i=n.angular.module("naif.base64",[]);i.directive("baseSixtyFourInput",["$window","$q",function(n,i){var u={onChange:"&",onAfterValidate:"&",parser:"&"},r=["onabort","onerror","onloadstart","onloadend","onprogress","onload"];return r.forEach(function(n){u[n]="&"}),{restrict:"A",require:"ngModel",scope:u,link:function(u,f,e,o){function l(n){if(e.maxnum&&e.multiple&&n){var t=n.length<=parseInt(e.maxnum);o.$setValidity("maxnum",t)}return n}function a(n){if(e.minnum&&e.multiple&&n){var t=n.length>=parseInt(e.minnum);o.$setValidity("minnum",t)}return n}function v(n){var i=!0,r,t,u;if(e.maxsize&&n){if(r=parseFloat(e.maxsize)*1e3,e.multiple){for(t=0;t<n.length;t++)if(u=n[t],u.filesize>r){i=!1;break}}else i=n.filesize<=r;o.$setValidity("maxsize",i)}return n}function y(n){var i=!0,r=parseFloat(e.minsize)*1e3,t,u;if(e.minsize&&n){if(e.multiple){for(t=0;t<n.length;t++)if(u=n[t],u.filesize<r){i=!1;break}}else i=n.filesize>=r;o.$setValidity("minsize",i)}return n}function p(n){var i=!0,t,s,r,u,f;if(e.accept&&(s=e.accept.trim().replace(/[,\s]+/gi,"|").replace(/\./g,"\\.").replace(/\/\*/g,"/.*"),t=new RegExp(s)),e.accept&&n){if(e.multiple){for(u=0;u<n.length;u++)if(f=n[u],r="."+f.filename.split(".").pop(),i=t.test(f.filetype)||t.test(r),!i)break}else r="."+n.filename.split(".").pop(),i=t.test(n.filetype)||t.test(r);o.$setValidity("accept",i)}return n}function c(){var n=e.multiple?h:h[0];o.$setViewValue(n);v(n);y(n);l(n);a(n);p(n)}function w(n,t,i,r,u){i[n]=function(n){t()(n,i,r,s,h,u)}}function b(r,f,o){return function(c){var a=c.target.result,l,v=e.maxsize&&f.size>e.maxsize*1024;if(o.base64=e.doNotParseIfOversize!==t&&v?null:n._arrayBufferToBase64(a),l=e.parser?i.when(u.parser()(f,o)):i.when(o),l.then(function(n){h.push(n);f.deferredObj.resolve()}),e.onload)if(u.onload&&typeof u.onload()=="function")u.onload()(c,r,f,s,h,o);else u.onload(c,s)}}function k(n,t,i){for(var f,o=r.length-1;o>=0;o--)f=r[o],e[f]&&f!=="onload"&&w(f,u[f],n,t,i);n.onload=b(n,t,i)}function d(){for(var f=[],t=s.length-1;t>=0;t--)s[t].deferredObj=i.defer(),f.push(s[t].deferredObj.promise);for(i.all(f).then(c),t=s.length-1;t>=0;t--){var e=new n.FileReader,r=s[t],u={};u.filetype=r.type;u.filename=r.name;u.filesize=r.size;k(e,r,u);e.readAsArrayBuffer(r)}}function g(n){if(e.onChange)if(u.onChange&&typeof u.onChange()=="function")u.onChange()(n,s);else u.onChange(n,s)}function nt(n){var r,t;if(e.onAfterValidate){for(r=[],t=s.length-1;t>=0;t--)r.push(s[t].deferredObj.promise);i.all(r).then(function(){if(u.onAfterValidate&&typeof u.onAfterValidate()=="function")u.onAfterValidate()(n,h,s);else u.onAfterValidate(n,h,s)})}}var s=[],h=[];if(o){o.$isEmpty=function(n){return!n||(angular.isArray(n)?n.length===0:!n.base64)};u._clearInput=function(){f[0].value=""};u.$watch(function(){return o.$viewValue},function(n){o.$isEmpty(n)&&o.$dirty&&(u._clearInput(),o.$setValidity("maxnum",!0),o.$setValidity("minnum",!0),o.$setValidity("maxsize",!0),o.$setValidity("minsize",!0),o.$setValidity("accept",!0))});f.on("change",function(n){h=[];h=angular.copy(h);n.target.files.length===0?(s=[],c()):(s=n.target.files,d(),g(n),nt(n));e.allowSameFile&&u._clearInput()})}}}}])})(window);